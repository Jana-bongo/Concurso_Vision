from flask import Flask, render_template, request, redirect, url_for, session, flash
import pymysql
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime
import os

app = Flask(__name__)
app.secret_key = 'sua_chave_secreta_aqui_mude_isso'

# Configurações do MySQL
DB_CONFIG = {
    'host': 'localhost',
    'user': 'root',  # SEU USUÁRIO MYSQL
    'password': 'sua_senha',  # SUA SENHA MYSQL
    'database': 'concurso_vision'
}

def get_db():
    return pymysql.connect(**DB_CONFIG)

# Rota principal - redireciona para login
@app.route('/')
def index():
    if 'loggedin' in session:
        return redirect(url_for('home'))
    return redirect(url_for('login'))

# Rota de login
@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        email = request.form['email']
        password = request.form['password']
        
        cursor = mysql.connection.cursor()
        cursor.execute('SELECT * FROM usuarios WHERE email = %s', (email,))
        user = cursor.fetchone()
        cursor.close()
        
        if user and check_password_hash(user[3], password):
            session['loggedin'] = True
            session['id'] = user[0]
            session['nome'] = user[1]
            session['email'] = user[2]
            session['is_admin'] = user[4]
            return redirect(url_for('home'))
        else:
            flash('Email ou senha incorretos!', 'error')
    
    return render_template('login.html')

# Rota de cadastro
@app.route('/cadastro', methods=['GET', 'POST'])
def cadastro():
    if request.method == 'POST':
        nome = request.form['nome']
        email = request.form['email']
        password = request.form['password']
        
        cursor = mysql.connection.cursor()
        cursor.execute('SELECT * FROM usuarios WHERE email = %s', (email,))
        account = cursor.fetchone()
        
        if account:
            flash('Email já cadastrado!', 'error')
        else:
            hashed_password = generate_password_hash(password)
            cursor.execute('INSERT INTO usuarios (nome, email, senha, is_admin) VALUES (%s, %s, %s, %s)',
                         (nome, email, hashed_password, False))
            mysql.connection.commit()
            cursor.close()
            flash('Cadastro realizado com sucesso!', 'success')
            return redirect(url_for('login'))
    
    return render_template('cadastro.html')

# Rota da página inicial (após login)
@app.route('/home')
def home():
    if 'loggedin' not in session:
        return redirect(url_for('login'))
    
    cursor = mysql.connection.cursor()
    
    # Buscar concursos disponíveis
    cursor.execute('''SELECT * FROM concursos 
                      WHERE status = "disponivel" 
                      ORDER BY data_inscricao_inicio DESC''')
    disponiveis = cursor.fetchall()
    
    # Buscar concursos previstos
    cursor.execute('''SELECT * FROM concursos 
                      WHERE status = "previsto" 
                      ORDER BY data_criacao DESC''')
    previstos = cursor.fetchall()
    
    # Buscar concursos terminados
    cursor.execute('''SELECT * FROM concursos 
                      WHERE status = "terminado" 
                      ORDER BY data_inscricao_fim DESC LIMIT 10''')
    terminados = cursor.fetchall()
    
    cursor.close()
    
    return render_template('home.html', 
                         disponiveis=disponiveis,
                         previstos=previstos,
                         terminados=terminados,
                         is_admin=session.get('is_admin'))

# Rota para ver detalhes do concurso
@app.route('/concurso/<int:id>')
def concurso_detalhes(id):
    if 'loggedin' not in session:
        return redirect(url_for('login'))
    
    cursor = mysql.connection.cursor()
    cursor.execute('SELECT * FROM concursos WHERE id = %s', (id,))
    concurso = cursor.fetchone()
    cursor.close()
    
    if concurso:
        return render_template('concurso_detalhes.html', 
                             concurso=concurso,
                             is_admin=session.get('is_admin'))
    else:
        flash('Concurso não encontrado!', 'error')
        return redirect(url_for('home'))

# Rota para adicionar concurso (apenas admin)
@app.route('/admin/adicionar', methods=['GET', 'POST'])
def adicionar_concurso():
    if 'loggedin' not in session or not session.get('is_admin'):
        flash('Acesso negado!', 'error')
        return redirect(url_for('home'))
    
    if request.method == 'POST':
        nome = request.form['nome']
        orgao = request.form['orgao']
        vagas = request.form['vagas']
        escolaridade = request.form['escolaridade']
        status = request.form['status']
        link_edital = request.form.get('link_edital', '')
        data_inscricao_inicio = request.form.get('data_inscricao_inicio')
        data_inscricao_fim = request.form.get('data_inscricao_fim')
        data_prova = request.form.get('data_prova')
        descricao = request.form.get('descricao', '')
        
        cursor = mysql.connection.cursor()
        cursor.execute('''INSERT INTO concursos 
                         (nome, orgao, vagas, escolaridade, status, link_edital, 
                          data_inscricao_inicio, data_inscricao_fim, data_prova, descricao)
                         VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)''',
                      (nome, orgao, vagas, escolaridade, status, link_edital,
                       data_inscricao_inicio, data_inscricao_fim, data_prova, descricao))
        mysql.connection.commit()
        cursor.close()
        
        flash('Concurso adicionado com sucesso!', 'success')
        return redirect(url_for('home'))
    
    return render_template('admin_adicionar.html')

# Rota para editar concurso (apenas admin)
@app.route('/admin/editar/<int:id>', methods=['GET', 'POST'])
def editar_concurso(id):
    if 'loggedin' not in session or not session.get('is_admin'):
        flash('Acesso negado!', 'error')
        return redirect(url_for('home'))
    
    cursor = mysql.connection.cursor()
    
    if request.method == 'POST':
        nome = request.form['nome']
        orgao = request.form['orgao']
        vagas = request.form['vagas']
        escolaridade = request.form['escolaridade']
        status = request.form['status']
        link_edital = request.form.get('link_edital', '')
        data_inscricao_inicio = request.form.get('data_inscricao_inicio')
        data_inscricao_fim = request.form.get('data_inscricao_fim')
        data_prova = request.form.get('data_prova')
        descricao = request.form.get('descricao', '')
        
        cursor.execute('''UPDATE concursos 
                         SET nome=%s, orgao=%s, vagas=%s, escolaridade=%s, status=%s,
                             link_edital=%s, data_inscricao_inicio=%s, data_inscricao_fim=%s,
                             data_prova=%s, descricao=%s
                         WHERE id=%s''',
                      (nome, orgao, vagas, escolaridade, status, link_edital,
                       data_inscricao_inicio, data_inscricao_fim, data_prova, descricao, id))
        mysql.connection.commit()
        cursor.close()
        
        flash('Concurso atualizado com sucesso!', 'success')
        return redirect(url_for('concurso_detalhes', id=id))
    
    cursor.execute('SELECT * FROM concursos WHERE id = %s', (id,))
    concurso = cursor.fetchone()
    cursor.close()
    
    if concurso:
        return render_template('admin_editar.html', concurso=concurso)
    else:
        flash('Concurso não encontrado!', 'error')
        return redirect(url_for('home'))

# Rota para deletar concurso (apenas admin)
@app.route('/admin/deletar/<int:id>')
def deletar_concurso(id):
    if 'loggedin' not in session or not session.get('is_admin'):
        flash('Acesso negado!', 'error')
        return redirect(url_for('home'))
    
    cursor = mysql.connection.cursor()
    cursor.execute('DELETE FROM concursos WHERE id = %s', (id,))
    mysql.connection.commit()
    cursor.close()
    
    flash('Concurso deletado com sucesso!', 'success')
    return redirect(url_for('home'))

# Rota de logout
@app.route('/logout')
def logout():
    session.pop('loggedin', None)
    session.pop('id', None)
    session.pop('nome', None)
    session.pop('email', None)
    session.pop('is_admin', None)
    return redirect(url_for('login'))

if __name__ == '__main__':
    app.run(debug=True)